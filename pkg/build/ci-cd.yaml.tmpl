# Generated by packages/build-a-build

name: TMTY CI/CD

on:
  push:
    branches:
    - trunk

jobs:
{{- range .Artifacts }}
  {{ .JobId }}:
    name: Build {{ .Id }}
    runs-on: ubuntu-latest
  {{- if .HasDependencies }}
    needs:
    {{- range .Dependencies }}
      - {{ .JobId }}
    {{- end }}
  {{- end }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2
    - uses: actions/setup-go@v3
      with:
        go-version: '1.18'
    - uses: google-github-actions/auth@v0
      with:
        credentials_json: {{ secret "SA_KEY" }}
    - uses: google-github-actions/setup-gcloud@v0
    - run: gcloud --quiet auth configure-docker

    - name: Build {{ .Id }}
      env:
        PROJECT_ID: {{ secret "PROJECT_ID" }}
      run: |-
        go run github.com/itura/fun/cmd/build@v0.1.7 build-artifact {{ .Id }} \
          --config {{ $.ConfigPath }} \
          --current-sha $GITHUB_SHA \
          --project-id $PROJECT_ID
{{ end }}

{{- range .Applications }}
  {{ .JobId }}:
    name: Deploy {{ .Id }}
    runs-on: ubuntu-latest
  {{- if .HasDependencies }}
    needs:
    {{- range .Upstreams }}
    - {{ .JobId }}
    {{- end }}
  {{- end }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2
    - uses: google-github-actions/auth@v0
      with:
        credentials_json: {{ secret "SA_KEY" }}
    - uses: actions/setup-go@v3
      with:
        go-version: '1.18'
    - uses: google-github-actions/get-gke-credentials@v0
      with:
        cluster_name: {{ secret "GKE_CLUSTER" }}
        location: {{ secret "GKE_LOCATION" }}
    - uses: azure/setup-helm@v1
      with:
        version: v3.10.2

    - name: Deploy {{ .Id }}
      env:
        PROJECT_ID: {{ secret "PROJECT_ID" }}
      {{- range .Values }}
        {{ resolveKey . }}: {{ resolveValue . }}
      {{- end }}
      run: |-
        go run github.com/itura/fun/cmd/build@v0.1.7 deploy-application {{ .Id }} \
          --config {{ $.ConfigPath }} \
          --current-sha $GITHUB_SHA \
          --project-id $PROJECT_ID
{{- end }}
